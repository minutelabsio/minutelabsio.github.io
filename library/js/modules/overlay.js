/*! Copyright (c) 2008 Brandon Aaron (brandon.aaron@gmail.com || http://brandonaaron.net)
         * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) 
         * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
         */

define(["jquery","stapes","require","tpl!templates/overlay.tpl"],function(e,t,n,r){function p(){if(h===!1)if(e("html.lt-ie9").length){var t=e('<textarea cols="10" rows="2"></textarea>').css({position:"absolute",top:-1e3,left:-1e3}).appendTo(c),n=e('<textarea cols="10" rows="2" style="overflow: hidden;"></textarea>').css({position:"absolute",top:-1e3,left:-1e3}).appendTo(c);h=t.width()-n.width(),t.add(n).remove()}else{var r=e("<div />").css({width:100,height:100,overflow:"auto",position:"absolute",top:-1e3,left:-1e3}).prependTo(c).append("<div />").find("div").css({width:"100%",height:200});h=100-r.width(),r.parent().remove()}return h}function d(t){var n=e(t),r=n.first(),i=r.scrollTop();return n.length?(r.scrollTop(i-(i!==0?2:-2)),r.scrollTop()!==i?(r.scrollTop(i),r):d(n.not(r))):n}function v(t,r){var i;return f?f.compile(t).render(r):(i=e.Deferred(),n(["dot"],function(e){f=e,i.resolve(v(t,r))}),i.promise())}function m(e){this.isOpen=!1,this.attached=!1,this.setOptions(e),this.init()}var i=".sticky",s="overlay-on",o="overlay-wrap",u=null,a={},f,l=!0,c;e(function(){c=e("body"),typeof l=="function"&&l(),l=!1});var h=!1;m.prototype={setOptions:function(t){this.config=e.extend(this.config||{content:!1,dataType:"html",type:"GET",wrapClassName:"",template:r,duration:500,detachOnClose:!1,filter:null},t)},init:function(){this.dfds={}},getDfd:function(t){var n=this.dfds[t],r=n===undefined||n.state()!=="pending";return r&&(n=this.dfds[t]=e.Deferred()),{dfd:n,init:r}},render:function(){if(this.el)return!0;var t=this,n=this.getDfd("render");return n.init&&e.when(this.makeModel()).then(function(){typeof t.config.template=="string"?e.when(v(t.config.template,t.model)).then(function(r){t.el=e(r),n.dfd.resolve(this)}):(t.el=e(t.config.template.render(t.model)),n.dfd.resolve(this))}),n.dfd.promise()},makeModel:function(){if(this.model)return!0;var t=this,n=this.getDfd("makeModel");return n.init&&e.when(this.getContent(!0)).then(function(){t.model={content:t.content,wrapClassName:o+" "+t.config.wrapClassName},n.dfd.resolve()}),n.dfd.promise()},getContent:function(t){var n=this;if(!this.content||!t)if(typeof this.config.content=="object")this.content=this.config.content;else if(this.config.content.match(" "))this.content=this.config.content;else{if(!this.config.content.match(/^#/))return e.ajax({url:this.config.content,type:this.config.type,data:this.config.dataString,dataType:this.config.dataType}).then(function(t){e.isFunction(n.config.filter)?n.content=n.config.filter(t):n.content=t});this.content=e(this.config.content).html()}return this.content},attach:function(t){var n=this,r;return this.attached?(t&&t(this),this):(r=this.getDfd("attach"),r.init&&e.when(this.render()).then(function(){n.attached||(n.attached=!0,n.el.hide().appendTo(c),n.el=n.el.filter(function(){return this.nodeType===1})),r.dfd.resolve(),t&&t(this)}),r.dfd.promise())},detach:function(t){var n=this,r;return this.attached?(r=this.getDfd("detach"),r.init&&e.when(this.close()).then(function(){n.attached&&(n.attached=!1,n.el.detach()),r.dfd.resolve(),t&&t(this)}),r.dfd.promise()):(t&&t(this),this)},on:function(){var t=this,n=arguments;e.when(this.attach()).then(function(){e.fn.on.apply(t.el,n)})},open:function(t){var n=this,r;return this.isOpen?(t&&t(this),this):(r=this.getDfd("open"),r.init&&e.when(this.attach()).then(function(){n.isOpen?t&&t(this):(n.isOpen=!0,n.el.css("top",d("html, body").scrollTop()||0).fadeIn(n.config.duration,function(){r.dfd.resolve(),t&&t(this)}))}),r.dfd.promise())},close:function(e){var t=this,n;return this.isOpen?(n=this.getDfd("close"),n.init&&this.el.fadeOut(this.config.duration,function(){t.config.detachOnClose&&t.detach(),e&&e(this),t.isOpen=!1,n.dfd.resolve()}),n.dfd.promise()):(e&&e(this),this)}};var g=t.subclass({open:function(t,n){var r=this,o,f,h=typeof t.content=="string"?t.content:JSON.stringify(t.content);if(!t.content)throw"You need to set options.content";return l?(l=function(){r.open(t,n)},this):(o=e.Deferred(),f=a[h],u&&u!==f?u.detach(o.resolve):o.resolve(),e.when(o.promise()).then(function(){!t.refresh&&f?u=f:(h in a&&(f.detach(),a[h]=!1),t=e.extend({closeButtons:".close, .inner",scrollfix:!0},t),u=a[h]=new m(t),u.on({click:function(n){e(n.target).is(t.closeButtons)&&(n.preventDefault(),r.close())}},t.closeButtons),r.on("open",function(e,n){r.off(n.type,n.handler),r.emit("create",t)}));var o=d("html, body");if(u.config.scrollfix&&o.length){o.css({paddingRight:"+="+p()+"px"}),c.css("overflow","hidden"),e(i).css("width",function(){var t=e(this);return t.width()<parseInt(t.css("maxWidth"),10)?"-="+p()+"px":""});var l;r.on("close",l=function(){o.css({paddingRight:""}),c.css("overflow",""),r.off("close",l)})}c.addClass(s),u.open(function(){n&&n(),r.emit("open",r)})}),this)},close:function(t){var n=this;return l?(l=!0,this):(c.removeClass(s),e(i).css("width",""),u.close(function(){t&&t(),n.emit("close",n)}),this)},getElement:function(){return u?u.el:null}});return new g});