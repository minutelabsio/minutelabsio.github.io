define(["jquery","json!site-config"],function(e,t){function s(n,s,o,a){var f,l,c;if(!s||typeof s!="string")a=o,o=s,s=n,n="GET";a=a||{},s=s.split(".");if(s.length<2)throw'Malformed api rule parameter "'+s.join(".")+'". Must be of form "<scope>.<service>"';f=t[s[0]],l=f.services[s[1]],typeof l=="string"&&(l={path:l,params:{}}),a.type=n,a.dataType=a.dataType||f.dataType||"json",c=u(l.path,o).replace(i,""),a.url=(f.base||"")+c,a.data=e.extend({},l.params,o);while(c=r.exec(l.path)&&RegExp.$2)(l.params&&l.params[c]===undefined||a.data[c]===null)&&delete a.data[c];return a}function o(e,t){var r=typeof t,i;if(r==="string"||arguments.length>2)t=Array.prototype.slice.call(arguments),t.shift();return i=r==="object",e.replace(n,function(e,n,r,s){var o=e.charAt(0)==="(",u=i?t[n]:t[~~n];if(u===undefined&&!o)throw"Non-optional path parameter "+e+" not specified.";return u||u===0?encodeURIComponent(u):""})}function u(e,t){var n=typeof t;if(n==="string"||arguments.length>2)t=Array.prototype.slice.call(arguments),t.shift();return e.replace(r,function(e,n,r,i,s){var o=t[r];switch(n){case"+":o=o.replace(/\s/g,"%20");break;default:o=encodeURIComponent(o)}return o||o===0?o:""})}function a(t){return typeof t=="object"||e.isArray(t)?JSON.stringify(t):t.toString()}function l(t,n){var r,i=n&&a(n);return i&&(r=f[i])?r:(r=e.Deferred(t),r.always(function(){delete f[i]}),f[i]=r.promise())}function c(t,n,r){var i;if(n!=="parsererror")try{i=e.parseJSON(t.responseText).meta.error}catch(s){i={}}else i={code:0,message:"Parse error"};return{code:i.code||t.status,message:i.message,type:i.type,httpStatus:r,httpCode:t.status}}t=t.api;var n=/\(?:([\w]+)\)?/g,r=/\{([+]?)([\w]+)\}/g,i=/\/$/,f={};return{prepare:s,pathParams:o,uriTemplate:u,publicDfd:l,formatError:c}});